\documentclass[a4,oneside]{article}
\usepackage[colorlinks=true,linkcolor=blue,citecolor=blue]{hyperref}
\usepackage{natbib}
\usepackage{times}
\usepackage{listings}
\usepackage[table]{xcolor}
%\PassOptionsToPackage{table}{xcolor}
\usepackage{color}
%\usepackage{colortbl}
\usepackage{marginnote}
\usepackage{rotating}
\usepackage{lipsum}
\usepackage{longtable}
\usepackage{array}
\usepackage{amsmath}
\usepackage{mdframed,lipsum}
\newcolumntype{L}{>{\raggedright\arraybackslash\hangindent=1em}}
\newcolumntype{M}{>{\raggedright\arraybackslash\hangindent=1em\ttfamily}}
\newcolumntype{X}{>{\nullfont}c}
\def\tablesetup{\rowcolors{2}{light-gray}{light-gray}\footnotesize}
\newmdenv[
  leftmargin = 0pt,
  innerleftmargin = 1em,
  innertopmargin = 0pt,
  innerbottommargin = 0pt,
  innerrightmargin = 0pt,
  rightmargin = 0pt,
  linewidth = 1pt,
  topline = false,
  rightline = false,
  bottomline = false
  ]{leftbar}
%\DeclareTextCommand{\_}{OT1}{\leavevmode\vbox{\hrule width.5em}}
% Use proper underscore character
\chardef\_=`\_
% Set math in Times Roman
\DeclareSymbolFont{letters}{OML}{ptmcm}{m}{it}
\DeclareSymbolFont{operators}{OT1}{ptmcm}{m}{n}
%\DeclareSymbolFont{bold}     {OML}{ptmcm}{b}{it}
\DeclareMathAlphabet{\mathbf}{OT1}{ptm}{b}{n}
% Page set up
\setlength{\oddsidemargin}{0cm} %{0.5cm}
\setlength{\evensidemargin}{0cm} %{0.5cm}
\setlength{\topmargin}{-2cm}
\setlength{\textheight}{24cm}
\setlength{\textwidth}{16cm}
\setlength{\marginparsep}{0.5cm}
\setlength{\marginparwidth}{0cm}
\setlength{\parindent}{1em}
\setlength{\parskip}{0cm}
\renewcommand{\baselinestretch}{1.1}
\sloppy

% Configure appearance of code listings
\definecolor{light-gray}{gray}{0.92}
\def\codesize{\small}
\def\codetabsize{\footnotesize}
\lstset{language=Fortran,
  backgroundcolor=\color{light-gray},
  basicstyle=\footnotesize\ttfamily,
  numbersep=5pt,
  xleftmargin=0cm,
  xrightmargin=0cm,
  emph={true,false,include,to},
  emphstyle=\relax}
\lstset{showstringspaces=false}

% Table-of-contents configuration
\usepackage{tocloft}
\setlength\cftparskip{-2pt}
\setlength\cftbeforesecskip{1pt}
\setlength\cftaftertoctitleskip{2pt}
\renewcommand\cftsecfont{\normalfont}
\renewcommand\cftsecpagefont{\normalfont}
\renewcommand{\cftsecleader}{\cftdotfill{\cftsecdotsep}}
\renewcommand\cftsecdotsep{\cftdot}
\renewcommand\cftsubsecdotsep{\cftdot}

% Page headers
\usepackage{fancyhdr}
\pagestyle{fancy}
\renewcommand{\headrulewidth}{0.5pt}
\renewcommand{\sectionmark}[1]{\markright{\thesection.\ #1}}
\renewcommand{\subsectionmark}[1]{}
\fancyhead[RO,RE]{\thepage}
\fancyfoot[C]{}

% Symbols and macros
\def\spsurf{\emph{SPARTACUS-Surface}}
\def\code#1{{\codesize\texttt{#1}}}
\def\codetab#1{{\codetabsize\texttt{#1}}}
\def\codeemph#1{{\codesize\texttt{\textbf{#1}}}}
\def\codetabemph#1{{\codetabsize\texttt{\textbf{#1}}}}
\def\textemph#1{\textbf{#1}}
\def\citem#1{\item[{\codesize\texttt{#1}}]}
\def\codestyle#1{\texttt{#1}}
\renewcommand\thefootnote{\relax}
\def\chapter{\section}
\reversemarginpar

% Title material
\title{SPARTACUS-Surface User Guide}

\author{Robin J. Hogan\\ \emph{European Centre for Medium Range
    Weather Forecasts, Reading, UK}}

\date{Document version 0.6 (February 2020) applicable to
  \spsurf\ version 0.6\thanks{This document is copyright
    \copyright\ European Centre for Medium Range Weather Forecasts
    2019. If you have any queries about \spsurf\ that are not
    answered by this document or by the information on the \spsurf\ web
    site
    (\url{http://www.met.reading.ac.uk/clouds/spartacus})
    then please email me at
    \href{mailto:r.j.hogan@ecmwf.int}{\texttt{r.j.hogan@ecmwf.int}}.}}
\begin{document}
\maketitle

%\tableofcontents
\def\thefootnote{\fnsymbol{footnote}}
\chapter{Introduction}
%\section{What is \spsurf?}
\spsurf\ is a Fortran-2003 software library for computing the 3D
interaction of solar (or \emph{shortwave}) and thermal-infrared (or
\emph{longwave}) radiation with complex surface canopies, especially
forests and urban areas. It uses a multi-layer description of the
canopy but with a statistical description of the horizontal
distribution of trees and buildings. This greatly reduces the
variables needed to describe the canopy, and makes the scheme fast
enough to use in weather and climate models.

The detailed theoretical basis of the library is provided in two
papers: \cite{Hogan+2018} developed the shortwave forest solver, and
\cite{Hogan2019} extended this to include buildings and longwave
radiative transfer.\footnote{These works developed two prototype codes
  in Matlab: \emph{SPARTACUS-Vegetation} and \emph{SPARTACUS-Urban},
  both available from the SPARTACUS web site.}  The resulting
algorithm combines three key ideas from earlier papers in the
atmospheric radiative transfer literature:
%
\begin{itemize}
\item To represent horizontal variations in vegetation leaf density
  (or equivalently, extinction coefficient), each layer in a
  vegetation canopy is divided horizontally into three regions:
  clear-air (unvegetated) and two vegetated regions of equal
  fractional cover but different extinction coefficient.  This
  approach was proposed by \cite{Shonk+2008}, who showed (in the
  context of cloudy radiative transfer) that the radiative effect of
  the full distribution of extinction coefficient could be
  approximated well given an appropriate choice for the extinction
  coefficients of the two regions.
\item Three-dimensional radiative effects are treated rigorously by
  using the \emph{Speedy Algorithm for Radiative Transfer through
    Cloud Sides} (SPARTACUS) of \cite{Hogan+2016}, but replacing
  clouds with trees and buildings.  Since it is reasonable to treat
  trees and buildings as randomly distributed in the horizontal plane,
  the rate of exchange of radiation between the clear and vegetated
  parts of a layer may be assumed to be proportional to the length of
  the interface between them, and likewise for the rate of
  interception of radiation by building walls.
\item The \emph{Discrete Ordinate Method} is used to approximate the
  zenithal distribution of diffuse radiation, with the coupled
  ordinary differential equations solved by Eigen decomposition
  similarly to \cite{Stamnes+1988}. This is more robust than the
  matrix-exponential method used by \cite{Hogan+2016}, and more
  accurate since the diffuse radiation field may be described by more
  than just two streams.
\end{itemize}

%Chapter
Section \ref{sec:compile} describes how to compile and use the offline
version of \spsurf, which is essentially a Unix program that reads a
configuration file and a netCDF file containing a description of a
number of surfaces, and outputs a netCDF file containing the computed
radiation properties. Sections
\ref{sec:run}--\ref{sec:nam_radsurf_config} describe how to configure
and run the offline software, and the contents of the input and output
data files.  Section \ref{sec:api} will describe to incorporate
\spsurf\ into a larger Fortran program, such as an atmospheric model.

%Chapter \ref{ch:api} describes the Application Programming Interface
%(API) enabling \spsurf\ to be incorporated into a larger Fortran
%program such as an atmospheric model. Chapter \ref{ch:structure}
%describes the internal architecture of the \spsurf\ software. Chapter
%\ref{ch:science} provides the scientific documentation, including the
%equations solved by \spsurf.

%\chapter{Using the offline radiation scheme}
%\label{ch:offline}
\section{Compiling the package}
\label{sec:compile}
The offline version of \spsurf\ is designed to be used on a Unix-like
platform. You will need a Fortran compiler that supports the 2003
standard, such as \code{gfortran}.
%
As a prerequisite, you will need to install the netCDF library,
including the Fortran interface (packages to install on a Linux system
are typically called \code{libnetcdff-dev} or
\code{libnetcdff-devel}).  If you have a recent netCDF version then
the command
\begin{lstlisting}
 nc-config --fc
\end{lstlisting}
should return the Fortran compiler for which the netCDF library was
compiled.  To run some of the tests, you will also need to install the
NCO utilities for manipulating netCDF Files.

First unpack the package and enter the subdirectory as follows:
\begin{lstlisting}
 tar xvfz spartacus_surface-0.8.tar.gz
 cd spartacus_surface-0.8
\end{lstlisting}
The latest snapshot may also be obtained from GitHub.  On a non-GNU
platform you may need to untar and unzip the package using the
\code{tar} and \code{gunzip} commands separately. The \code{README}
file contains concise instructions on compilation and testing, while
the \code{COPYING} file provides the license conditions (Apache
License, version 2.0). The subdirectories are as follows:
%
\begin{description}
\citem{radsurf} The \spsurf\ souce code for canopy radiative transfer
\citem{radtool} Mathematical support routines for radiative transfer
\citem{ifsaux} Source code providing a (sometimes dummy) IFS environment
\citem{utilities} Source code for useful utilities, such as reading netCDF
       files
\citem{driver} The source code for the offline driver program \code{spartacus\_surface}
\citem{mod} Where Fortran module files are written
\citem{lib} Where the static libraries are written
\citem{bin} Where the executable \code{ecrad} is written
\citem{test} Test cases including Matlab code to plot the outputs
\citem{doc} The source for this document
\end{description}

Compilation on different platforms using different compilers is
facilitated by the various \code{Makefile\_include.<prof>} files in the
top-level directory: if you type
%
\begin{lstlisting}
 make
\end{lstlisting}
%
or
%
\begin{lstlisting}
 make PROFILE=gfortran
\end{lstlisting}
%
the code will be compiled using the \code{gfortran} compiler via the
Makefile variables set in the \code{Makefile\_include.gfortran}
file. Using instead \code{PROFILE=pgi} will use the
\code{Makefile\_include.pgi} file to attempt to compile with the PGI
compiler, while \code{PROFILE=intel} selects the Intel compiler.  If
everything goes to plan this should create the executable
\code{bin/spartacus\_surface} and various static libraries in the \code{lib}
directory.

One common reason the code doesn't compile out of the box is that it
can't find the netCDF library files.  The \spsurf\ Makefile uses the
\code{nf-config} script that comes with recent versions of the netCDF
library to create the Makefile variables \code{NETCDF\_INCLUDE} and
\code{NETCDF\_LIB}. If \code{nf-config} is not available on your
system, or it fails to correctly locate the netCDF library files, then
the cleanest way to fix this is to create a
\code{Makefile\_include.local} file (starting from one of the existing
\code{Makefile\_include.*} files) that defines \code{NETCDF\_INCLUDE}
and \code{NETCDF\_LIB} explicity to contain arguments for the compile
and link operations, respectively.  Suppose you installed netCDF in
\code{/path/to/netcdf} and you use the \code{gfortran} compiler then
your file might contain:
\begin{lstlisting}
 include Makefile_include.gfortran
 NETCDF = /path/to/netcdf
 NETCDF_INCLUDE = -I$(NETCDF)/include
 NETCDF_LIB = -L$(NETCDF)/lib -lnetcdff -lnetcdf -Wl,-rpath,$(NETCDF)/lib
\end{lstlisting}
You should then be able to build the code with
%
\begin{lstlisting}
 make PROFILE=local
\end{lstlisting}
%
Examples of such configurations for the ECMWF and University of
Reading computer systems may be found in
\code{Makefile\_include.ecmwf} and \code{Makefile\_include.uor}.

%To compile in single precision, type
%\begin{lstlisting}
% make PROFILE=gfortran SINGLE_PRECISION=1
%\end{lstlisting}
To compile with debugging options turned on (no optimization, bounds
checking and initializing real numbers with not-a-number), type
\begin{lstlisting}
 make PROFILE=gfortran DEBUG=1
\end{lstlisting}
Finer tuning may be achieved by overriding the optimization and
debugging flags used in \code{Makefile} explicitly, for example
\begin{lstlisting}
 make PROFILE=gfortran OPTFLAGS="-O1" DEBUGFLAGS="-g1 -pg"
\end{lstlisting}
Remember that if you change the compile settings you will probably
want to recompile everything, in which case you first need to remove
all compiled files with
\begin{lstlisting}
 make clean
\end{lstlisting}

\section{Running the offline scheme}
\label{sec:run}
 To test the code, type
\begin{lstlisting}
 make test
\end{lstlisting}
which runs \code{make} in each of the subdirectories of the
\code{test} directory. The \code{README} files in these directories
provide more information on what they are doing, and some Matlab
scripts are provided to visualize the outputs.

You will see in the output of the tests the command line in each
invocation of \spsurf, which is of the form
%
\begin{lstlisting}
 spartacus_surface config.nam input.nc output.nc
\end{lstlisting}
where \code{spartacus\_surface} needs to be the full path to the
\spsurf\ executable, \code{config.nam} is a Fortran namelist file
configuring the code, \code{input.nc} contains the input atmospheric
profiles and \code{output.nc} contains the output irradiance (flux)
profiles.  The namelist file contains a \code{radsurf} namelist that
configures the \spsurf\ scheme itself; the parameters available are
described in section \ref{sec:nam_radsurf}. The file also contains a
\code{radsurf\_config} namelist that configures aspects of the offline
package, described in section \ref{sec:nam_radsurf_config}.  Only the
\code{radsurf} namelist is used when \spsurf\ is incorporated into an
atmospheric model.

The input netCDF file contains numerous floating-point variables
listed in Table \ref{tab:invar}. The dimensions are shown in the order
that they are listed by the \code{ncdump} utility, with the first
dimension varying slowest in the file (opposite to the Fortran
convention).  Most variables are stored as a function of column and
layer (dimensions named \code{col} and \code{layer} in Table
\ref{tab:invar}, although the actual dimension names are ignored by
\spsurf). The \code{layer\_int} dimension corresponds to interfaces
between layers, plus the top-of-canopy and surface, and so must be one
more than \code{layer}. Note that both \code{layer} and
\code{layer\_int} should increase upwards from the surface. The
optional \code{sw} and \code{lw} dimensions allow for shortwave and
longwave optical properties of leaves and facets to be specified in
user-defined spectral intervals. Some variables can be omitted in
which case default values will be used or these fields will be
constructed according to \code{radsurf\_config} namelist parameters
(section \ref{sec:nam_radsurf_config}).

\begin{center}
\tablesetup
\begin{longtable}{llLp{8cm}}%
\caption{\label{tab:invar}Main variables contained in the input netCDF
  file to \spsurf.}\\
%
\hline
Variable & Dimensions & Description \\
\hline
\codetab{cos\_solar\_zenith\_angle} & \codetab{col} & Cosine of solar zenith angle \\
\codetab{surface\_type} & \codetab{col} & Surface type (integer): (0) flat, (1) forest, (2) urban, and (3) vegetated urban \\
\codetab{height} & \codetab{col, layer\_int} & Height of layer interfaces (m) \\
\codetab{veg\_fraction} & \codetab{col, layer} & Vegetation fraction \\
\codetab{veg\_scale} & \codetab{col, layer} & Vegetation horizontal scale (m) \\
\codetab{veg\_extinction} & \codetab{col, layer} & Wavelength-independent vegetation extinction coefficient (m$^{-1}$) \\
\codetab{veg\_fsd} & \codetab{col, layer} & Fractional standard deviation of vegetation extinction \\
\codetab{veg\_contact\_fraction} & \codetab{col, layer} & Fraction of vegetation edge in contact with building walls \\
%
\codetab{building\_fraction} & \codetab{col, layer} & Building fraction \\
\codetab{building\_scale} & \codetab{col, layer} & Building horizontal scale (m) \\
%
\codetab{clear\_air\_temperature} & \codetab{col, layer} & Temperature of clear (unvegetated) part of layer (K) \\
\codetab{veg\_temperature} & \codetab{col, layer} & Temperature of leaves (K) \\
\codetab{veg\_air\_temperature} & \codetab{col, layer} & Temperature of air in vegetated part of layer (K) \\
\codetab{air\_temperature} & \codetab{col, layer} & Alternative way to specify \codetab{clear\_air\_temperature} and \codetab{veg\_air\_temperature} if the same (K) \\
\codetab{ground\_temperature} & \codetab{col} & Ground temperature (K) \\
\codetab{roof\_temperature} & \codetab{col, layer} & Temperature of the roofs at the top of the layer (K) \\
\codetab{wall\_temperature} & \codetab{col, layer} & Wall temperature (K) \\
%
\codetab{ground\_sw\_albedo} & \codetab{col, sw} & Shortwave albedo of ground \\
\codetab{ground\_sw\_albedo\_direct} & \codetab{col, sw} & Shortwave albedo of ground to direct beam (if different)\\
\codetab{ground\_lw\_emissivity} & \codetab{col, lw} & Longwave emissivity of ground \\
%
\codetab{veg\_sw\_ssa} & \codetab{col, layer, sw} & Shortwave single-scattering albedo of the leaves \\
\codetab{veg\_lw\_ssa} & \codetab{col, layer, lw} & Longwave single-scattering albedo of the leaves \\
%
\codetab{roof\_sw\_albedo} & \codetab{col, layer, sw} & Shortwave albedo of roofs \\
\codetab{roof\_sw\_albedo\_direct} & \codetab{col, layer, sw} & Shortwave albedo of roofs to direct beam (if different)\\
\codetab{roof\_lw\_emissivity} & \codetab{col, layer, lw} & Longwave emissivity of roofs \\
%
\codetab{wall\_sw\_albedo} & \codetab{col, layer, sw} & Shortwave albedo of walls \\
\codetab{wall\_sw\_specular\_fraction} & \codetab{col, layer, sw} & Fraction of wall reflection that is specular \\
\codetab{wall\_lw\_emissivity} & \codetab{col, layer, lw} & Longwave emissivity of walls \\
%
\codetab{sky\_temperature} & \codetab{col, layer} & Equivalent emitting temperature of sky (K) \\
\codetab{top\_flux\_dn\_sw} & \codetab{col, layer, sw} & Top-of-canopy downwelling shortwave flux (W m$^{-1}$) \\
\codetab{top\_flux\_dn\_direct\_sw} & \codetab{col, layer, sw} & Top-of-canopy downwelling direct shortwave flux (W m$^{-1}$) \\
\hline
\end{longtable}
\end{center}

All the test data store input fields in order of increasing height,
and the output data use the same convention. 

The output netCDF file contains the typical set of broadband fluxes
and absorption rates listed in Table \ref{tab:outvar}. If you need
them spectrally resolved (using the input spectral discretization)
then set the \code{radsurf\_config} namelist variable
\code{do\_spectral} to \code{true} and the same variables will be
output but with the prefix \code{spectral\_}.

\begin{center}
\tablesetup
\begin{longtable}{llLp{7cm}}%
\caption{\label{tab:outvar}Variables contained in the output netCDF
  file from \spsurf.  All fluxes (or irradiances) and absorption rates
  have units of W~m$^{-2}$, but note that this is power per unit area
  of the \emph{entire domain}, not per unit area of a specific facet
  type.  `Net' fluxes are defined as the flux into a facet type (or downward) minus the
  flux out of a facet type (or upward).}\\
%
\hline
Variable & Dimensions & Description\\
\hline
\codetab{height} & \codetab{col, layer\_int} & Height of layer interfaces above ground (m)\\
\codetab{ground\_flux\_dn\_sw} & \codetab{col} & Downwelling shortwave flux into the ground \\
\codetab{ground\_flux\_net\_sw} & \codetab{col} & Net shortwave flux into the ground\\
\codetab{ground\_flux\_dn\_direct\_sw} & \codetab{col} & Direct downwelling shortwave flux into the ground\\
\codetab{top\_flux\_dn\_sw} & \codetab{col} & Top-of-canopy downwelling shortwave flux\\
\codetab{top\_flux\_net\_sw} & \codetab{col} & Top-of-canopy net shortwave flux\\
\codetab{top\_flux\_dn\_direct\_sw} & \codetab{col} & Top-of-canopy direct downwelling shortwave flux\\
\codetab{roof\_flux\_in\_sw} & \codetab{col, layer} & Shortwave flux into roofs \\
\codetab{roof\_flux\_net\_sw} & \codetab{col, layer} & Net shortwave flux into roofs\\
\codetab{wall\_flux\_in\_sw} & \codetab{col, layer} & Shortwave flux into walls\\
\codetab{wall\_flux\_net\_sw} & \codetab{col, layer} & Net shortwave flux into walls\\
\codetab{clear\_air\_absorption\_sw} & \codetab{col, layer} & Shortwave absorption rate in clear-air part of layer\\
\codetab{veg\_absorption\_sw} & \codetab{col, layer} & Shortwave absorption rate by leaves\\
\codetab{veg\_air\_absorption\_sw} & \codetab{col, layer} & Shortwave absorption rate by air in vegetated part of layer\\
\codetab{ground\_flux\_dn\_lw} & \codetab{col} & Downwelling longwave flux into the ground\\
\codetab{ground\_flux\_net\_lw} & \codetab{col} & Net longwave flux into the ground\\
\codetab{top\_flux\_dn\_lw} & \codetab{col} & Top-of-canopy donwelling longwave flux\\
\codetab{top\_flux\_net\_lw} & \codetab{col} & Top-of-canopy net longwave flux\\
\codetab{roof\_flux\_in\_lw} & \codetab{col, layer} & Longwave flux into roofs\\
\codetab{roof\_flux\_net\_lw} & \codetab{col, layer} & Net longwave flux into roofs\\
\codetab{wall\_flux\_in\_lw} & \codetab{col, layer} & Longwave flux into walls\\
\codetab{wall\_flux\_net\_lw} & \codetab{col, layer} & Net flux into walls\\
\codetab{clear\_air\_absorption\_lw} & \codetab{col, layer} & Net longwave absorption rate in clear-air part of layer\\
\codetab{veg\_absorption\_lw} & \codetab{col, layer} & Net longwave absorption rate by leaves\\
\codetab{veg\_air\_absorption\_lw} & \codetab{col, layer} & Net longwave absorption rate by air in vegetated part of layer\\
\hline
\end{longtable}
\end{center}


\section{Configuring the \spsurf\ algorithm}
\label{sec:nam_radsurf}
The detailed settings of \spsurf\ are configured using the
\code{radsurf} namelist in the namelist file provided as the first
command-line argument to the \code{ecrad} executable. The available
namelist parameters are listed in Table \ref{tab:nam_radsurf}. 

%\newcommand{\namedef}{3}{\code{#1} & #2 & #3\\}

%\begin{table}
\begin{center}
\tablesetup
%\begin{longtable}{lc>{\raggedright}p{5cm}>{\raggedright}p{5cm}}
%\begin{longtable}{lXLp{4cm}Lp{5.5cm}}
\begin{longtable}{lXlLp{5.5cm}}
%
\caption{\label{tab:nam_radsurf}Options for the \code{radsurf}
  namelist that configures \spsurf\ algorithm. The type of each
  parameter can be inferred from its name: logicals begin with
  \code{do\_} or \code{use\_}, integers start with \code{i\_} or
  \code{n\_}, strings end with \code{\_name}, and all other parameters
  are real numbers.}\\
%
\hline
Parameter & Type & \textbf{Default}, other values & Description\\
\hline
%\namedef{do_sw}{\codetab{true},\codetab{false}}{Run the shortwave scheme?}
\multicolumn{4}{l}{\emph{General}}\\
\codetab{do\_sw} & L & \codetabemph{true} & Compute shortwave fluxes?\\
\codetab{do\_lw} & L & \codetabemph{true} & Compute longwave fluxes?\\
\codetab{do\_vegetation} & L & \codetabemph{true} & Will vegetation be represented? \\
\codetab{do\_urban} & L & \codetabemph{true} & Will urban areas be represented? \\
\codetab{use\_sw\_direct\_albedo} & L & \codetabemph{false} & Specify ground and roof albedos separately for direct solar radiation? \\
\codetab{min\_vegetation\_fraction} & R & \codetabemph{10$^{-6}$} & Minimum area fraction below which a region is removed completely\\
\hline
\multicolumn{4}{l}{\emph{Options specific to forest tiles}}\\
\codetab{n\_vegetation\_region\_forest} & I & \codetabemph{1}, \code{2} & Number of regions used to describe vegetation (2 needed for heterogeneity)\\
\codetab{n\_stream\_sw\_forest} & I & \codetabemph{4} & Streams per hemisphere to describe diffuse shortwave radiation\\
\codetab{n\_stream\_sw\_forest} & I & \codetabemph{4} & Streams per hemisphere to describe longwave radiation\\
\codetab{use\_symmetric\_vegetation\_scale\_forest} & L & \codetabemph{true} & Compute vegetation perimeter length using Eq.\ 20 of \cite{Hogan+2018}? Otherwise Eq.\ 19\\
\codetab{vegetation\_isolation\_factor\_forest} & R & \codetabemph{0.0}, \code{0.0}--\code{1.0} & Dense vegetation region is (0.0) embedded within sparse region or (1.0) in physically isolated regions\\
\hline
\multicolumn{4}{l}{\emph{Options specific to urban tiles}}\\
\codetab{n\_vegetation\_region\_urban} & I & \codetabemph{1}, \code{2} & Number of regions used to describe vegetation (2 needed for heterogeneity)\\
\codetab{n\_stream\_sw\_urban} & I & \codetabemph{4} & Streams per hemisphere to describe diffuse shortwave radiation\\
\codetab{n\_stream\_sw\_urban} & I & \codetabemph{4} & Streams per hemisphere to describe longwave radiation\\
\codetab{use\_symmetric\_vegetation\_scale\_urban} & L & \codetabemph{true} & Compute vegetation perimeter length using Eq.\ 20 of \cite{Hogan+2018}? Otherwise Eq.\ 19\\
\codetab{vegetation\_isolation\_factor\_urban} & R & \codetabemph{0.0}, \code{0.0}--\code{1.0} & Dense vegetation region is (0.0) embedded within sparse region or (1.0) in physically isolated regions\\
%\hline
%\multicolumn{4}{l}{\emph{Gas and aerosol optics}}\\
%\codetab
\hline
% To be added:
%     &  do_canopy_gases_sw, do_canopy_gases_lw, 
\end{longtable}
\end{center}
%\end{table}

%\section{Describing the structure of vegetation and buildings}
%\label{sec:d_structure}
\iffalse
Normalized perimeter length is related to the former via Eq.\ 29 of
%\cite{Hogan+2019}:
%
\begin{equation}
  L=4c(1-c)/C_S,\label{eq:S}
\end{equation}
%
%and to the latter via \cite[]{Fielding+2020}
%
\begin{equation}
  L=4\left[c(1-c)\right]^{1/2}/C_X,\label{eq:X}
\end{equation}
%
where $c$ is the cloud fraction. 
\fi

\section{Configuring the offline package}
\label{sec:nam_radsurf_config}
In addition to the namelist parameters described in section
\ref{sec:nam_radsurf} an additional set of parameters are available in
the \code{radsurf\_config} namelist that are specific to the offline
version of \spsurf\ and are listed in Table
\ref{tab:nam_radsurf_config}. In general if these parameters are
present in the namelist then they will override the corresponding
variable provided in the input file.

\begin{center}
\tablesetup
\begin{longtable}{ll}
%
\caption{\label{tab:nam_radsurf_config}Options for the
  \code{radsurf\_config} namelist that configures additional aspects
  of the offline radiation scheme. All entries must be scalars. If an
  override parameter is present then usually it need not be included
  in the input file.}\\
%
\hline
Parameter & Description\\
\hline
\multicolumn{2}{l}{\emph{Execution control}}\\
\codetab{nrepeat}  & Number of times to repeat, for benchmarking\\
\codetab{istartcol} & Start at specified input column (1 based)\\
\codetab{iendcol} & End at specified input column (1 based)\\
\codetab{iverbose} & Verbosity in offline setup (default 2)\\
\codetab{do\_parallel} & Use OpenMP parallelism? (default \codetab{true})\\
\codetab{nblocksize} & Number of columns per block when using OpenMP\\
\codetab{do\_conservation\_check} & Check final energy balance for each column\\
\hline
\multicolumn{2}{l}{\emph{Override input variables}}\\
\codetab{cos\_solar\_zenith\_angle} & Override cosine of solar zenith angle\\
\codetab{ground\_sw\_albedo} & Override shortwave albedo of ground\\
\codetab{roof\_sw\_albedo} & Override shortwave albedo of roofs\\
\codetab{wall\_sw\_albedo} & Override shortwave albedo of walls\\
\codetab{ground\_lw\_emissivity} & Override longwave emissivity of ground\\
\codetab{roof\_lw\_emissivity} & Override longwave emissivity of roofs\\
\codetab{wall\_lw\_emissivity} & Override longwave emissivity of walls\\
\codetab{vegetation\_fraction} & Override vegetation fraction \\
\codetab{vegetation\_extinction} & Override vegetation extinction coefficient (m$^{-1}$)\\
\codetab{vegetation\_fsd} & Override vegetation fractional standard deviation of extinction\\
\codetab{vegetation\_sw\_ssa} & Override vegetation shortwave single scattering albedo \\
\codetab{vegetation\_lw\_ssa} & Override vegetation longwave single scattering albedo \\
\codetab{top\_flux\_dn\_sw} & Override top-of-canopy downwelling shortwave flux (W~m$^{-2}$)\\
\codetab{top\_flux\_dn\_direct\_sw} & Override top-of-canopy downwelling direct shortwave flux (W~m$^{-2}$)\\
\codetab{top\_flux\_dn\_lw} & Override top-of-canopy downwelling longwave flux (W~m$^{-2}$)\\
\hline
\end{longtable}
\end{center}

\section{Checking the configuration}
\label{sec:checking}
When \code{spartacus\_surface} is run, it outputs to the screen a
summary of the configuration options, with the level of detail
controled by the \code{radsurf\_config} namelist parameter
\code{iverbose}. This can be used to check that \spsurf\ has been
configured as intended.  The following is an example from the default
test in the \code{test/simple} directory, in the case of
\code{iverbose=2}:

\footnotesize
\begin{verbatim}
------------------ OFFLINE SPARTACUS-SURFACE RADIATION SCHEME ------------------
Copyright (C) 2019-2020 European Centre for Medium-Range Weather Forecasts
Contact: Robin Hogan (r.j.hogan@ecmwf.int)
Floating-point precision: double
General settings:
  Represent vegetation ON                 (do_vegetation=T)
  Represent urban areas ON                (do_urban=T)
  Do shortwave (SW) calculations ON       (do_sw=T)
  Do longwave (LW) calculations ON        (do_sw=T)
  Number of SW spectral intervals = 1     (nsw)
  Number of LW spectral intervals = 1     (nlw)
  Minimum vegetation fraction = .100E-05  (min_vegetation_fraction)
Settings for forests:
  Number of vegetation regions = 2        (n_vegetation_region_forest)
  Use symmetric vegetation scale ON       (use_symmetric_vegetation_scale_forest=T)
  Vegetation isolation factor = 0.00      (vegetation_isolation_factor_forest)
  SW diffuse streams per hemisphere = 2   (n_stream_sw_forest)
  LW streams per hemisphere = 2           (n_stream_lw_forest)
Settings for urban areas:
  Number of vegetation regions = 2        (n_vegetation_region_urban)
  Use symmetric vegetation scale ON       (use_symmetric_vegetation_scale_urban=T)
  Vegetation isolation factor = 0.00      (vegetation_isolation_factor_urban)
  SW diffuse streams per hemisphere = 2   (n_stream_sw_urban)
  LW streams per hemisphere = 2           (n_stream_lw_urban)
Reading NetCDF file test_surfaces_in.nc
  Overriding cosine of the solar zenith angle with  0.500    
  Overriding vegetation extinction with  0.250    
  Setting temperature of clear-air and air in vegetation to air_temperature
  Setting vegetation temperature equal to air temperature
  Assuming roof albedo to direct albedo is the same as to diffuse
  Assuming wall reflection is Lambertian (no specular component)
    1: Flat
    2: Forest,            2 layers, 2 diffuse streams per hemisphere, 3 regions
    3: Unvegetated urban, 2 layers, 2 diffuse streams per hemisphere, 1 region
    4: Vegetated urban,   2 layers, 2 diffuse streams per hemisphere, 3 regions
Direct shortwave budget
Layer   Ground      Air     Wall     Roof      Veg  Air-veg      Top   Residual
    1  320.000    0.000    0.000    0.000    0.000    0.000  320.000  0.000E+00
    2   87.441    0.000    0.000    0.000  293.893    0.000  381.334  0.568E-13
    3   51.015    0.000  185.652  119.081    0.000    0.000  355.748 -0.568E-13
    4   25.686    0.000  163.389  119.057   51.620    0.000  359.752  0.000E+00
Diffuse shortwave budget
Layer   Ground      Air     Wall     Roof      Veg  Air-veg      Top   Residual
    1   80.000    0.000    0.000    0.000    0.000    0.000   80.000  0.000E+00
    2   27.565    0.000    0.000    0.000   67.146    0.000   94.710  0.000E+00
    3   20.203    0.000   37.465   30.846    0.000    0.000   88.514  0.000E+00
    4   13.199    0.000   33.583   30.840   12.105    0.000   89.726 -0.142E-13
Internal longwave budget
Layer   Ground      Air     Wall     Roof      Veg  Air-veg      Top   Residual
    1 -328.035    0.000    0.000    0.000    0.000    0.000 -328.035  0.000E+00
    2 -327.647    0.031    0.000    0.000  216.819    0.011 -110.785  0.847E-05
    3  -80.093   -0.158 -138.486 -125.417    0.000    0.000 -344.211  0.569E-01
    4  -55.546   -0.151 -130.312 -125.423  -32.158   -0.002 -343.627  0.351E-01
Incoming longwave budget
Layer   Ground      Air     Wall     Roof      Veg  Air-veg      Top   Residual
    1  263.855    0.000    0.000    0.000    0.000    0.000  263.855  0.000E+00
    2   89.108    0.029    0.000    0.000  198.716    0.010  287.868 -0.416E-02
    3   64.432    0.157  111.365  100.876    0.000    0.000  276.877 -0.462E-01
    4   41.886    0.146  101.133  100.871   34.728    0.002  278.796 -0.287E-01
Writing NetCDF file test_surfaces_out.nc
--------------------------------------------------------------------------------

\end{verbatim}
\normalsize

\section{Incorporating \spsurf\ into another program}
\label{sec:api}
%\label{ch:api}

\spsurf\ can be called within a larger program and in due course this
section will explain how to do it.

\iffalse

\chapter{Code structure}
\label{ch:structure}

\section{Objects}


\chapter{Scientific documentation}
\label{ch:science}

\section{Gas optics}

\section{Aerosol optics}

\section{Cloud optics}

\section{Solvers}
\fi

\begin{thebibliography}{00}
\markright{References}
%
\harvarditem{Hogan et~al.}{2018}{Hogan+2018}Hogan, R. J., T. Quaife
and R. Braghiere, 2018: Fast matrix treatment of 3-D radiative
transfer in vegetation canopies: SPARTACUS-Vegetation
1.1. \textit{Geosci.\ Model Dev.,} \textbf{11,} 339-350.
%
\harvarditem{Hogan}{2019}{Hogan2019}Hogan, R. J., 2019: Flexible
treatment of radiative transfer in complex urban canopies for use in
weather and climate models. \textit{Boundary-Layer Meteorol.,}
\textbf{173,} 53-78.

%\harvarditem{Fielding~et~al.}{2020}{Fielding+2020}Fielding, M. D.,
%S. A. K. Sch\"afer, R. J. Hogan and R. M. Forbes, 2020: Encapsulating
%cloud geometry for 3D radiative transfer and cloud turbulent mixing
%parameterizations. \emph{To be submitted to Q. J. R. Meteorol.\ Soc.}
%
%\harvarditem{Hogan and Bozzo}{2018}{Hogan+2018}Hogan, R. J., and
%A. Bozzo, 2018: A flexible radiation scheme for the ECMWF
%model. \textit{J. Adv.\ Model.\ Earth Syst.,} \textbf{10,}
%doi:10.1029/2018MS001364.
%
\harvarditem{Hogan~et~al.}{2016}{Hogan+2016}Hogan, R. J.,
S. A. K. Sch\"afer, C. Klinger, J.-C. Chiu and B. Mayer, 2016:
Representing 3D cloud-radiation effects in two-stream schemes:
2. Matrix formulation and broadband
evaluation. \textit{J. Geophys.\ Res.,} \textbf{121,} 8583--8599.
%
%\harvarditem{Hogan~et~al.}{2019}{Hogan+2019}Hogan, R. J.,
%M. D. Fielding, H. W. Barker, N. Villefranque and S. A. K. Sch\"afer,
%2019: Entrapment: An important mechanism to explain the shortwave 3D
%radiative effect of clouds. \textit{J. Atmos.\ Sci.,} \textbf{76,}
%2123--2141.
%
\harvarditem{Shonk and Hogan}{2008}{Shonk+2008}Shonk, J. K. P., and
R. J. Hogan, 2008: Tripleclouds: an efficient method for representing
horizontal cloud inhomogeneity in 1D radiation schemes by using three
regions at each height. \textit{J. Climate,} \textbf{21,} 2352--2370.
%
\harvarditem{Stamnes et~al.}{1988}{Stamnes+1988}Stamnes K.,
S. C. Tsay, W. Wiscombe and K. Jayaweera, 1988: Numerically stable
algorithm for discrete-ordinate-method radiative transfer in multiple
scattering and emitting layered media. \textit{Appl.\ Opt.,}
\textbf{27,} 2502--2509.
\end{thebibliography}
\end{document}
